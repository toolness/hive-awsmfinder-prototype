<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<script src="https://api.tiles.mapbox.com/mapbox.js/v1.6.1/mapbox.js"></script>
<link rel="stylesheet" href="https://api.tiles.mapbox.com/mapbox.js/v1.6.1/mapbox.css">
<style>
body {
  margin: 0;
  padding: 0;
}

#map {
  position: absolute;
  top: 0;
  bottom: 0;
  width: 100%;
}

.awsm-title {
  font-weight: bold;
}

a.awsm-details {
  display: inline-block;
  font-size: smaller;
  background: #f0f0f0;
  padding: 0 4px;
}

#panel a {
  color: #3887BE;
  text-decoration: none;
}

#panel a:hover {
  color: #63b6e5;
}

#panel {
  -webkit-box-sizing: border-box;
  box-sizing: border-box;
  max-height: 33%;
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: white;
  margin: 20px;
  padding: 0 20px;
  font-family: 'Helvetica Neue', Arial, Helvetica, sans-serif;
  font-size: 15px;
  line-height: 25px;
  color: rgba(0, 0, 0, 0.75);
  overflow: scroll;
}
</style>
<title>AWSM Finder Prototype</title>
<div id="map"></div>
<div id="panel">
  <h1>Afterschool Programs for Teens: Mid-Winter 2014 Edition</h1>
</div>
<script src="jquery.js"></script>
<script src="underscore.js"></script>
<script type="text/html" id="tooltip">
<% programs.forEach(function(program) { %>
  <div class="awsm-title"><%- program.title %></div>
  <p><%- program.tagline %> <a class="awsm-details" href="#<%- program.id %>">details&hellip;</a></p>
<% }) %>
</script>
<script>
var map = L.mapbox
  .map('map')
  .setView([40.738, -73.936], 12)
  .addLayer(L.mapbox.tileLayer('toolness.map-137lwd3c', {
    detectRetina: true
  }));

function makeMarker(options) {
  return L.mapbox.markerLayer({
    type: 'Feature',
    geometry: {
      type: 'Point',
      coordinates: [options.coordinates.lng, options.coordinates.lat]
    },
    properties: {
      'marker-size': 'small',
      'marker-color': '#f0a'
    }
  });
}

function getTagline(programs, id) {
  var li = $('li > a[href="#' + id + '"]', programs).parent().clone();
  $('a', li).remove();
  return li.text().slice(1);
}

$.when(
  $.ajax('afterschool-programs.html'),
  $.ajax('geocodes.json')
).done(function(programs, geocodes) {
  var addrInfo = {};
  programs = $('<div></div>').append($(programs[0]));
  geocodes = geocodes[0];
  $('h3', programs).each(function() {
    var id = $(this).prev('p').find('a').attr('name');
    var tagline = getTagline(programs, id);
    var title = $(this).text();
    var content = $('<div></div>').append($(this).nextUntil('h3').clone());
    $('.hive-address', content).each(function() {;
      var address = $.trim($(this).text());
      if (address && address in geocodes) {
        var unique_addr = geocodes[address].formatted_address;
        if (!(unique_addr in addrInfo))
          addrInfo[unique_addr] = [];
        addrInfo[unique_addr].push({
          coordinates: geocodes[address],
          id: id,
          title: title,
          tagline: tagline,
          content: content.html()
        });
      }
    });
    Object.keys(addrInfo).forEach(function(addr) {
      var tooltipHTML = _.template($("#tooltip").text(), {
        programs: addrInfo[addr]
      });
      makeMarker({
        coordinates: addrInfo[addr][0].coordinates
      }).bindPopup(tooltipHTML, {
        closeButton: false,
        minWidth: 320
      }).addTo(map);
    });
    $("img", programs).remove();
    $("#panel").append(programs);
  });
});
</script>
